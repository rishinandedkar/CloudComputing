{
   "AWSTemplateFormatVersion":"2010-09-09",
   "Description":"CI-CD Stack",
   "Parameters":{
      "s3domain":{
         "Description":"S3 Bucket Name",
         "Type":"String"
      },
      "accid":{
         "Description":"Account Id",
         "Type":"String"
      }
   },
   "Resources":{
      "EC2ToS3BucketInstanceProfile":{
         "Type":"AWS::IAM::InstanceProfile",
         "Properties":{
            "Path":"/",
            "Roles":[
               {
                  "Ref":"EC2ToS3BucketRole"
               }
            ],
            "InstanceProfileName":"EC2ToS3BucketInstanceProfile"
         }
      },

      "EC2ToSNSPolicy" :{
      "Type" : "AWS::IAM::ManagedPolicy",
      "Properties" : {
        "ManagedPolicyName" : "EC2ToSNSPolicy",
        "PolicyDocument" : {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Action": [
                "SNS:Publish"
              ],
              "Resource": "*"
            }
          ]
        },
        "Roles" : [
          {
            "Ref" : "EC2ToS3BucketRole"
          }
        ]
      }
    },
      "EC2ToCloudWatchPolicy":{
         "Type":"AWS::IAM::ManagedPolicy",
         "Properties":{
            "ManagedPolicyName":"EC2ToCloudWatchPolicy",
            "PolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Action":[
                        "logs:*",
                        "cloudwatch:*"
                     ],
                     "Resource":[
                        "*"
                     ]
                  }
               ]
            },
            "Roles":[
               {
                  "Ref":"EC2ToS3BucketRole"
               }
            ]
         }
      },

<<<<<<< HEAD
      "EC2ToSNSPolicy" :{
      "Type" : "AWS::IAM::ManagedPolicy",
      "Properties" : {
        "ManagedPolicyName" : "EC2ToSNSPolicy",
        "PolicyDocument" : {
          "Version": "2012-10-17",
          "Statement": [
						{
            "Effect": "Allow",
            "Action": [
                "SNS:Publish"
                      ],
            "Resource": "*"
						}
					]
        },
        "Roles" : [
          {
            "Ref" : "EC2ToS3BucketRole"
          }
        ]
      }
},

      "LambdaRole":{
         "Type":"AWS::IAM::Role",
         "Properties":{
            "RoleName":"LambdaExecutionRole",
            "AssumeRolePolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Principal":{
                        "Service":[
                           "lambda.amazonaws.com"
                        ]
                     },
                     "Action":[
                        "sts:AssumeRole"
                     ]
                  }
               ]
            },
            "ManagedPolicyArns":[
               "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
               "arn:aws:iam::aws:policy/AmazonDynamoDBFullAccess",
               "arn:aws:iam::aws:policy/AmazonSESFullAccess"
            ]
         }
      },
      "EC2ToS3BucketPolicy":{
         "Type":"AWS::IAM::ManagedPolicy",
         "Properties":{
            "ManagedPolicyName":"EC2ToS3BucketPolicy",
=======
      "EC2ToS3BucketPolicy":{

         "Type":"AWS::IAM::ManagedPolicy",
         "Properties":{
            "ManagedPolicyName":"EC2ToS3BucketPolicy",

>>>>>>> 43326347b3bcdd00b7bc9c19dd3aeb7311344095
            "PolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Action":[
                        "s3:Get*",
                        "s3:Put*",
                        "s3:List*",
                        "s3:Delete*"
                     ],
                     "Resource":"*"
                  }
               ]
            },
            "Roles":[
               {
                  "Ref":"EC2ToS3BucketRole"
               }
            ]
         }
      },
      "EC2ToS3BucketRole":{
         "Type":"AWS::IAM::Role",
         "Description":"EC2ToS3BucketRole",
         "Properties":{
<<<<<<< HEAD
           "ManagedPolicyArns" : ["arn:aws:iam::aws:policy/CloudWatchAgentAdminPolicy"],
=======
           "ManagedPolicyArns" : [
           "arn:aws:iam::aws:policy/CloudWatchAgentAdminPolicy",
           "arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy",
           "arn:aws:iam::aws:policy/AmazonRDSFullAccess",
           "arn:aws:iam::aws:policy/AmazonS3FullAccess",
           "arn:aws:iam::aws:policy/AmazonSNSFullAccess"],
>>>>>>> 43326347b3bcdd00b7bc9c19dd3aeb7311344095
            "AssumeRolePolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Principal":{
                        "Service":[
                           "ec2.amazonaws.com"
                        ]
                     },
                     "Action":[
                        "sts:AssumeRole"
                     ]
                  }
               ]
            },
            "Path":"/",
            "Policies":[
               {
                  "PolicyName":"CodeDeploy-EC2-S3",
                  "PolicyDocument":{
                     "Version":"2012-10-17",
                     "Statement":[
                        {
                           "Effect":"Allow",
                           "Action":[
                              "s3:Get*",
                              "s3:List*"
                           ],
                           "Resource":{
                              "Fn::Join":[
                                 "",
                                 [
                                    "arn:aws:s3:::",
                                    {
                                       "Ref":"s3domain"
                                    },
                                    "/*"
                                 ]
                              ]
                           }
                        }
                     ]
                  }
               }
            ]
         }
      },
      "TravisToS3BucketPolicy":{
         "Type":"AWS::IAM::ManagedPolicy",
         "Properties":{
<<<<<<< HEAD
            "Users":[
               "travis"
            ],
=======
            "Users":["travis"],
>>>>>>> 43326347b3bcdd00b7bc9c19dd3aeb7311344095
            "ManagedPolicyName":"TravisToS3BucketPolicy",
            "PolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Action":[
                        "s3:Get*",
                        "s3:List*",
                        "s3:PutObject*"
                     ],
                     "Resource":[
                        {
                           "Fn::Join":[
                              "",
                              [
                                 "arn:aws:s3:::",
                                 {
                                    "Ref":"s3domain"
                                 },
                                 "/*"
                              ]
                           ]
                        }
                     ]
                  }
               ]
<<<<<<< HEAD
            },
=======
             },
>>>>>>> 43326347b3bcdd00b7bc9c19dd3aeb7311344095
            "Roles" : [
          {
            "Ref" : "TravisToS3BucketRole"
          }
        ]
<<<<<<< HEAD
         }
=======
        }
>>>>>>> 43326347b3bcdd00b7bc9c19dd3aeb7311344095
      },
      "TravisToS3BucketRole":{
         "Type":"AWS::IAM::Role",
         "Properties":{
            "AssumeRolePolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Principal":{
                        "Service":[
                           "ec2.amazonaws.com"
                        ]
                     },
                     "Action":[
                        "sts:AssumeRole"
                     ]
                  }
               ]
            },
            "Path":"/"
         }
      },
<<<<<<< HEAD

=======
>>>>>>> 43326347b3bcdd00b7bc9c19dd3aeb7311344095
      "TravisToS3BucketInstanceProfile" : {
      "Type" : "AWS::IAM::InstanceProfile",
      "Properties" : {
        "Path" : "/",
        "Roles" : [
          {
            "Ref" : "TravisToS3BucketRole"
          }
        ]
      }
    },
      "TravisToCodeDeployInstanceProfile":{
         "Type":"AWS::IAM::InstanceProfile",
         "Properties":{
           "Path":"/",

            "Roles":[{"Ref":"TravisToCodeDeployRole"}]
                }
         },
      "TravisToCodeDeployPolicy":{
         "Type":"AWS::IAM::ManagedPolicy",
<<<<<<< HEAD
         "Properties":{
            "Users":[
               "travis"
            ],
            "ManagedPolicyName":"TravisToCodeDeployPolicy",
=======
          "Properties":{
            "Users":[
               "travis"
            ],

            "ManagedPolicyName":"TravisToCodeDeployPolicy",

>>>>>>> 43326347b3bcdd00b7bc9c19dd3aeb7311344095
            "PolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Action":[
                        "codedeploy:RegisterApplicationRevision",
                        "codedeploy:GetApplicationRevision"
                     ],
                     "Resource":[
                        {
                           "Fn::Join":[
                              "",
                              [
                                 "arn:aws:codedeploy:us-east-1:",
                                 {
                                    "Ref":"accid"
                                 },
                                 ":application:APPLICATION_NAME"
                              ]
                           ]
                        }
                     ]
                  },
                  {
                     "Effect":"Allow",
                     "Action":[
                        "codedeploy:CreateDeployment",
                        "codedeploy:GetDeployment"
                     ],
                     "Resource":[
                        "*"
                     ]
                  },
                  {
                     "Effect":"Allow",
                     "Action":[
                        "codedeploy:GetDeploymentConfig"
                     ],
                     "Resource":[
                        {
                           "Fn::Join":[
                              "",
                              [
                                 "arn:aws:codedeploy:us-east-1:",
                                 {
                                    "Ref":"accid"
                                 },
                                 ":deploymentconfig:CodeDeployDefault.OneAtATime"
                              ]
                           ]
                        },
                        {
                           "Fn::Join":[
                              "",
                              [
                                 "arn:aws:codedeploy:us-east-1:",
                                 {
                                    "Ref":"accid"
                                 },
                                 ":deploymentconfig:CodeDeployDefault.HalfAtATime"
                              ]
                           ]
                        },
                        {
                           "Fn::Join":[
                              "",
                              [
                                 "arn:aws:codedeploy:us-east-1:",
                                 {
                                    "Ref":"accid"
                                 },
                                 ":deploymentconfig:CodeDeployDefault.AllAtOnce"
                              ]
                           ]
                        }
                     ]
                  }
               ]
            }
         }
      },
      "TravisToCodeDeployRole":{
         "Type":"AWS::IAM::Role",
         "Properties":{
            "AssumeRolePolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Principal":{
                        "Service":[
                           "ec2.amazonaws.com"
                        ]
                     },
                     "Action":[
                        "sts:AssumeRole"
                     ]
                  }
               ]
            },
            "Path":"/"
         }
      },
      "CodeDeployServiceRole":{
         "Type":"AWS::IAM::Role",
         "Properties":{
            "ManagedPolicyArns":[
               "arn:aws:iam::aws:policy/service-role/AWSCodeDeployRole"
            ],
            "AssumeRolePolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Principal":{
                        "Service":[
                           "ec2.amazonaws.com",
                           "codedeploy.amazonaws.com"
                        ]
                     },
                     "Action":[
                        "sts:AssumeRole"
                     ]
                  }
               ]
            },
            "RoleName":"CodeDeployServiceRole"
         }
      },
      "CodeDeployS3Bucket":{
         "Type":"AWS::S3::Bucket",
         "Properties":{
            "BucketName":{
               "Ref":"s3domain"
            }
         }
      }

   },
   "Outputs":{
      "CodeDeployServiceRoleArn":{
         "Description":"Code Deploy Arn",
         "Value":{
            "Fn::GetAtt":[
               "CodeDeployServiceRole",
               "Arn"
            ]
         }
      }
   }
 }
